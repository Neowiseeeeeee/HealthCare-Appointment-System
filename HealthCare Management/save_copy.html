<?php
session_start();

// Enable error reporting for debugging
error_reporting(E_ALL);
ini_set('display_errors', 1);

// Debug session data
error_log("Session data in dashboard: " . print_r($_SESSION, true));

// Check if user is logged in
if (!isset($_SESSION['user_id']) || !isset($_SESSION['role']) || $_SESSION['role'] !== 'patient') {
    header('Location: login.php');
    exit();
}

// Get user data from session
$user_id = $_SESSION['user_id'];
$user_name = $_SESSION['name'] ?? 'Name not available';
$user_email = $_SESSION['email'] ?? 'Email not available';
$user_role = $_SESSION['role'] ?? 'patient';

// Debug output
error_log("User data from session:");
error_log("User ID: " . $user_id);
error_log("Name: " . $user_name);
error_log("Email: " . $user_email);
error_log("Role: " . $user_role);
?>
<!DOCTYPE html>
<html lang="en">
 <head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1" name="viewport" />
  <title>DocNow Patient Profile Editable</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
   href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
   rel="stylesheet"
  />
  <script>
   // Toggle between edit and view mode
   function toggleEdit() {
    const editBtn = document.getElementById("editProfileBtn");
    const isEditing = editBtn.dataset.editing === "true";
    const container = document.getElementById("profileContainer");

    if (!isEditing) {
     // Enable editing: replace spans with inputs/selects/textarea
     const spans = container.querySelectorAll("span.editable-field");
     spans.forEach((span) => {
      const name = span.dataset.name;
      const inputType = span.dataset.type || "text";
      let input;
      if (name === "gender") {
       input = document.createElement("select");
       input.className = "border border-gray-300 rounded px-2 py-1 text-sm w-full bg-white";
       input.name = name;
       input.id = span.id;
       ["Male", "Female", "Other"].forEach((optionText) => {
        const option = document.createElement("option");
        option.value = optionText;
        option.textContent = optionText;
        if (span.textContent.trim() === optionText) option.selected = true;
        input.appendChild(option);
       });
      } else if (name === "maritalStatus") {
       input = document.createElement("select");
       input.className = "border border-gray-300 rounded px-2 py-1 text-sm w-full bg-white";
       input.name = name;
       input.id = span.id;
       ["Single", "Married", "Divorced", "Widowed"].forEach((optionText) => {
        const option = document.createElement("option");
        option.value = optionText;
        option.textContent = optionText;
        if (span.textContent.trim() === optionText) option.selected = true;
        input.appendChild(option);
       });
      } else if (inputType === "textarea") {
       input = document.createElement("textarea");
       input.rows = 3;
       input.className = "border border-gray-300 rounded px-2 py-1 text-sm w-full";
       input.value = span.textContent.trim();
       input.name = name;
       input.id = span.id;
      } else {
       input = document.createElement("input");
       input.type = inputType;
       input.className = "border border-gray-300 rounded px-2 py-1 text-sm w-full";
       input.value = span.textContent.trim();
       input.name = name;
       input.id = span.id;
      }
      span.replaceWith(input);
     });
     // Show profile picture input
     document.getElementById("profilePicInput").classList.remove("hidden");
     editBtn.textContent = "Save Profile";
     editBtn.dataset.editing = "true";
    } else {
     // Save editing: gather all form data
     const formData = new FormData();
     
     // Get all input values
     const inputs = container.querySelectorAll("input[type=text], input[type=number], textarea, select");
     inputs.forEach((input) => {
         if (input.value.trim() !== '') {
             formData.append(input.name, input.value.trim());
         }
     });

     // Show loading state
     editBtn.textContent = "Saving...";
     editBtn.disabled = true;

     // Send data to server
     fetch('update_profile.php', {
         method: 'POST',
         body: formData
     })
     .then(response => response.json())
     .then(data => {
         if (data.success) {
             // Show success message
             const successMessage = document.createElement('div');
             successMessage.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded shadow-lg z-50';
             successMessage.textContent = data.message || 'Profile updated successfully';
             document.body.appendChild(successMessage);
             setTimeout(() => successMessage.remove(), 3000);

             // Replace inputs with spans
             inputs.forEach((input) => {
                 const span = document.createElement("span");
                 span.className = "editable-field";
                 span.dataset.name = input.name;
                 span.id = input.id;
                 span.dataset.type = input.dataset.type || "text";
                 span.textContent = input.value.trim() || getDefaultText(input.name);
                 input.replaceWith(span);
             });

             // Hide profile picture input
             document.getElementById("profilePicInput").classList.add("hidden");
             
             // Reset button state
             editBtn.textContent = "Edit Profile";
             editBtn.dataset.editing = "false";
             editBtn.disabled = false;

             // Refresh the profile data
             displayProfileData();
         } else {
             throw new Error(data.message || 'Failed to update profile');
         }
     })
     .catch(error => {
         console.error('Error:', error);
         // Show error message
         const errorMessage = document.createElement('div');
         errorMessage.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded shadow-lg z-50';
         errorMessage.textContent = error.message || 'Failed to update profile';
         document.body.appendChild(errorMessage);
         setTimeout(() => errorMessage.remove(), 3000);
         
         // Reset button state
         editBtn.textContent = "Save Profile";
         editBtn.disabled = false;
     });
    }
   }

   // Helper function to get default text for fields
   function getDefaultText(fieldName) {
       const defaults = {
           'age': 'Not specified',
           'gender': 'Not specified',
           'maritalStatus': 'Not specified',
           'bio': 'No bio provided',
           'address': 'No address provided',
           'emergencyContactName': 'Not provided',
           'emergencyContactPhone': 'Not provided',
           'emergencyContactRelationship': 'Not specified',
           'phoneNumber': 'Not provided'
       };
       return defaults[fieldName] || 'Not specified';
   }

   // Handle profile picture change and preview
   function handleProfilePicChange(event) {
       const file = event.target.files[0];
       if (file) {
           // Show loading state
           const profilePic = document.getElementById('profilePic');
           const loadingDiv = document.getElementById('profilePicLoading');
           loadingDiv.classList.remove('hidden');
           
           // Create form data
           const formData = new FormData();
           formData.append('profile_picture', file);
           
           // Upload the file
           fetch('upload_profile_picture.php', {
               method: 'POST',
               body: formData
           })
           .then(response => response.json())
           .then(data => {
               if (data.success) {
                   // Update the image
                   profilePic.src = data.picture_path;
                   
                   // Show success message
                   const successMessage = document.createElement('div');
                   successMessage.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded shadow-lg z-50';
                   successMessage.textContent = 'Profile picture updated successfully';
                   document.body.appendChild(successMessage);
                   setTimeout(() => successMessage.remove(), 3000);
               } else {
                   throw new Error(data.message);
               }
           })
           .catch(error => {
               console.error('Error:', error);
               // Show error message
               const errorMessage = document.createElement('div');
               errorMessage.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded shadow-lg z-50';
               errorMessage.textContent = error.message || 'Failed to update profile picture';
               document.body.appendChild(errorMessage);
               setTimeout(() => errorMessage.remove(), 3000);
           })
           .finally(() => {
               loadingDiv.classList.add('hidden');
           });
       }
   }

   // Toggle settings menu visibility
   function toggleMenu() {
    const menu = document.getElementById("slideMenu");
    if (menu.classList.contains("hidden")) {
     menu.classList.remove("hidden");
    } else {
     menu.classList.add("hidden");
    }
   }

   // Close settings menu
   function closeMenu() {
    const menu = document.getElementById("slideMenu");
    menu.classList.add("hidden");
   }

   // Show notification or message modal
   function showNotification(content, isMessage = false, replyId = "") {
    const modal = document.getElementById("modal");
    const modalContent = document.getElementById("modalContent");
    const modalReply = document.getElementById("modalReply");
    const modalReplyTextarea = document.getElementById("modalReplyTextarea");
    const modalReplySend = document.getElementById("modalReplySend");

    modalContent.textContent = content;

    if (isMessage) {
     modalReply.classList.remove("hidden");
     modalReplyTextarea.value = "";
     modalReplySend.onclick = () => {
      if (modalReplyTextarea.value.trim() === "") {
       alert("Please enter a reply message.");
       return;
      }
      alert("Reply sent: " + modalReplyTextarea.value.trim());
      modalReplyTextarea.value = "";
      closeModal();
     };
    } else {
     modalReply.classList.add("hidden");
    }

    modal.classList.remove("hidden");
   }

   // Close modal
   function closeModal() {
    const modal = document.getElementById("modal");
    modal.classList.add("hidden");
   }

   // Toggle mobile menu
   function toggleMobileMenu() {
     const menu = document.getElementById('mobileMenu');
     const isOpen = !menu.classList.contains('translate-x-full');
     
     if (isOpen) {
       // Close menu
       menu.classList.add('translate-x-full');
     } else {
       // Open menu
       menu.classList.remove('translate-x-full');
     }
   }

   // Close mobile menu when clicking outside
   document.addEventListener('click', function(event) {
     const menu = document.getElementById('mobileMenu');
     const menuButton = document.getElementById('mobileMenuButton');
     
     if (!menu.contains(event.target) && !menuButton.contains(event.target) && !menu.classList.contains('translate-x-full')) {
       menu.classList.add('translate-x-full');
     }
   });

   // Appointment Modal Functions
   function showAppointmentDetails(appointment) {
    const modal = document.getElementById('appointmentModal');
    const detailsContainer = document.getElementById('appointmentDetails');
    
    // Example of appointment details HTML
    detailsContainer.innerHTML = `
     <div class="space-y-4">
      <div class="text-center mb-4">
       <img src="Pictures/appointment-details.jpg" alt="Appointment Details" class="rounded-lg mx-auto mb-4" style="max-height: 200px;">
      </div>
      <div class="grid grid-cols-2 gap-4 text-sm">
       <div class="font-semibold">Date & Time:</div>
       <div>${appointment.datetime}</div>
       <div class="font-semibold">Doctor:</div>
       <div>${appointment.doctor}</div>
       <div class="font-semibold">Type:</div>
       <div>${appointment.type}</div>
       <div class="font-semibold">Status:</div>
       <div>${appointment.status}</div>
       <div class="font-semibold">Location:</div>
       <div>${appointment.location}</div>
      </div>
      <div class="mt-4 p-3 bg-gray-50 rounded-lg">
       <div class="font-semibold mb-2">Notes:</div>
       <p class="text-sm text-gray-600">${appointment.notes}</p>
      </div>
     </div>
    `;
    
    modal.classList.remove('hidden');
    modal.classList.add('flex');
   }

   function closeAppointmentModal() {
    const modal = document.getElementById('appointmentModal');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
   }

   // Message Popup
   function showMessageDetails(message) {
    const modal = document.getElementById('messageModal');
    const contentContainer = document.getElementById('messageContent');
    
    contentContainer.innerHTML = `
     <h3 class="text-lg font-semibold text-gray-900 mb-2">${message.title}</h3>
     <p class="text-gray-800 mb-2">${message.content}</p>
     <p class="text-sm text-gray-500">${message.time}</p>
    `;
    
    modal.classList.remove('hidden');
    modal.style.display = 'flex';
    document.getElementById('messageReply').value = ''; // Clear previous reply
   }

   function closeMessageModal() {
    const modal = document.getElementById('messageModal');
    modal.classList.add('hidden');
    modal.style.display = 'none';
   }

   function sendReply() {
    const replyText = document.getElementById('messageReply').value;
    if (replyText.trim()) {
      // Here you would typically send the reply to your backend
      alert('Reply sent successfully!');
      closeMessageModal();
    }
   }

   // Add click handlers to appointments
   function initializeAppointmentHandlers() {
    // For upcoming appointments
    document.querySelectorAll('#upcomingAppointmentsList .bg-gray-50.rounded-lg').forEach(appointment => {
      appointment.addEventListener('click', () => {
        const appointmentData = {
          datetime: appointment.querySelector('p:first-child').textContent,
          doctor: appointment.querySelector('p:nth-child(2)').textContent,
          type: 'Regular Checkup',
          status: 'Scheduled',
          location: 'Main Clinic, Room 204',
          notes: 'Regular follow-up appointment. Please bring your medical records and any recent test results.'
        };
        showAppointmentDetails(appointmentData);
      });
    });

    // For appointment history
    document.querySelectorAll('#appointmentHistoryList .bg-gray-50.rounded-lg').forEach(appointment => {
      appointment.addEventListener('click', () => {
        const appointmentData = {
          datetime: appointment.querySelector('p:first-child').textContent,
          doctor: appointment.querySelector('p:nth-child(2)').textContent,
          type: 'Regular Checkup',
          status: appointment.querySelector('p:nth-child(3)').textContent,
          location: 'Main Clinic, Room 204',
          notes: 'Past appointment record. Click for more details.'
        };
        showAppointmentDetails(appointmentData);
      });
    });
   }

   // Initialize message handlers
   function initializeMessageHandlers() {
    // Add click handlers to message containers
    document.querySelectorAll('#messagesNotifications .rounded-lg').forEach(messageContainer => {
      messageContainer.classList.add('cursor-pointer');
      messageContainer.addEventListener('click', (e) => {
        // Don't trigger if clicking the reply button
        if (!e.target.classList.contains('text-blue-600')) {
          const messageData = {
            title: messageContainer.querySelector('p:first-child').textContent,
            content: messageContainer.querySelector('.text-sm').textContent,
            time: messageContainer.querySelector('.text-xs').textContent
          };
          showMessageDetails(messageData);
        }
      });
    });

    // Add click handlers to Reply buttons
    document.querySelectorAll('.text-blue-600').forEach(replyButton => {
      replyButton.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        // Get the parent message container
        const messageContainer = e.target.closest('.rounded-lg');
        if (messageContainer) {
          const messageData = {
            title: messageContainer.querySelector('p:first-child').textContent,
            content: messageContainer.querySelector('.text-sm').textContent,
            time: messageContainer.querySelector('.text-xs').textContent
          };
          showMessageDetails(messageData);
        }
      });
    });
   }

   // Initialize the page
   document.addEventListener('DOMContentLoaded', function() {
       // First set initial values from session
       const userName = <?php echo json_encode($user_name); ?>;
       const userEmail = <?php echo json_encode($user_email); ?>;
       const userRole = <?php echo json_encode($user_role); ?>;
       
       // Set initial values from session
       if (userName && document.getElementById('nameDisplay')) {
           document.getElementById('nameDisplay').textContent = userName;
       }
       if (userEmail && document.getElementById('emailDisplay')) {
           document.getElementById('emailDisplay').textContent = userEmail;
       }
       if (userRole && document.getElementById('roleDisplay')) {
           document.getElementById('roleDisplay').textContent = userRole.charAt(0).toUpperCase() + userRole.slice(1);
       }

       // Then fetch fresh data from the server
       displayProfileData();
       
       // Initialize other data
       fetchAndDisplayData();
       initializeAppointmentHandlers();
       initializeMessageHandlers();
   });

   // Function to display profile data
   function displayProfileData() {
       // Add timestamp to prevent caching
       const timestamp = new Date().getTime();
       const url = `api/get_patient_data.php?t=${timestamp}`;
       
       // Show loading state
       const fields = ['age', 'gender', 'maritalStatus', 'bio', 'address', 
                      'emergencyContactName', 'emergencyContactPhone', 
                      'emergencyContactRelationship', 'phoneNumber'];
       
       fields.forEach(field => {
           const element = document.getElementById(field);
           if (element) {
               element.classList.add('text-gray-400');
               element.textContent = 'Loading...';
           }
       });
       
       // Fetch patient data from the server
       fetch(url)
           .then(response => {
               if (!response.ok) {
                   throw new Error(`HTTP error! status: ${response.status}`);
               }
               return response.json();
           })
           .then(data => {
               if (data.success) {
                   const profileData = data.data;
                   
                   // Update session data in the UI
                   document.getElementById('nameDisplay').textContent = profileData.name;
                   document.getElementById('emailDisplay').textContent = profileData.email;
                   document.getElementById('roleDisplay').textContent = 
                       profileData.role.charAt(0).toUpperCase() + profileData.role.slice(1);
                   document.getElementById('userIdDisplay').textContent = `ID: ${profileData.user_id}`;
                   
                   // Set profile picture
                   const profilePic = document.getElementById('profilePic');
                   if (profileData.picture_path && !profileData.picture_path.includes('default-profile.png')) {
                       profilePic.src = profileData.picture_path;
                       profilePic.onerror = function() {
                           this.src = 'Pictures/Logo.jpg';
                       };
                   } else {
                       profilePic.src = 'Pictures/Logo.jpg';
                   }

                   // Update all editable fields
                   const fields = {
                       'age': { id: 'age', value: profileData.age, defaultText: 'Not specified' },
                       'gender': { id: 'gender', value: profileData.gender, defaultText: 'Not specified' },
                       'maritalStatus': { id: 'maritalStatus', value: profileData.marital_status, defaultText: 'Not specified' },
                       'bio': { id: 'bio', value: profileData.bio, defaultText: 'No bio provided' },
                       'address': { id: 'address', value: profileData.address, defaultText: 'No address provided' },
                       'emergencyContactName': { id: 'emergencyContactName', value: profileData.emergency_contact_name, defaultText: 'Not provided' },
                       'emergencyContactPhone': { id: 'emergencyContactPhone', value: profileData.emergency_contact_phone, defaultText: 'Not provided' },
                       'emergencyContactRelationship': { id: 'emergencyContactRelationship', value: profileData.emergency_contact_relationship, defaultText: 'Not specified' },
                       'phoneNumber': { id: 'phoneNumber', value: profileData.phone_number, defaultText: 'No phone number provided' }
                   };

                   Object.entries(fields).forEach(([key, field]) => {
                       const element = document.getElementById(field.id);
                       if (element) {
                           const value = field.value;
                           if (value && value !== '' && value !== 'Not specified' && value !== 'Not provided') {
                               element.textContent = value;
                               element.classList.remove('text-gray-400');
                           } else {
                               element.textContent = field.defaultText;
                               element.classList.add('text-gray-400');
                           }
                       }
                   });
               } else {
                   throw new Error(data.message || 'Failed to load profile data');
               }
           })
           .catch(error => {
               console.error('Error in fetch operation:', error);
               // Show error message to user
               const errorMessage = document.createElement('div');
               errorMessage.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded shadow-lg z-50';
               errorMessage.textContent = error.message || 'Error loading profile data';
               document.body.appendChild(errorMessage);
               setTimeout(() => errorMessage.remove(), 3000);
               
               // Reset fields to default state on error
               fields.forEach(field => {
                   const element = document.getElementById(field);
                   if (element) {
                       element.classList.add('text-gray-400');
                       element.textContent = 'Not specified';
                   }
               });
           });
   }

   // Add global variable for patient ID from session
   const PATIENT_ID = <?php echo json_encode($user_id); ?>;

   // Update database functions to include patient ID
   async function fetchPatientProfile() {
       const response = await fetch(`/api/patient/profile.php?patient_id=${PATIENT_ID}`);
       if (!response.ok) throw new Error('Failed to fetch profile');
       return response.json();
   }

   // Debug log - remove in production
   console.log('Session data passed to JavaScript:', {
       name: <?php echo json_encode($user_name); ?>,
       email: <?php echo json_encode($user_email); ?>,
       role: <?php echo json_encode($user_role); ?>,
       patient_id: <?php echo json_encode($user_id); ?>
   });
  </script>
  <style>
   @media (min-width: 1024px) {
    #profileContainer {
     max-height: none !important;
    }
    #appointmentsHistoryContainer {
     display: flex;
     flex-direction: column;
     gap: 1.5rem;
     height: 40%;
     min-height: 240px;
     max-height: 280px;
     justify-content: flex-start;
    }
    #upcomingAppointments,
    #appointmentHistory {
     flex: 1 1 0;
     display: flex;
     flex-direction: column;
     overflow: hidden;
    }
    #upcomingAppointments > h3,
    #appointmentHistory > h3 {
     position: sticky;
     top: 0;
     background: white;
     padding-top: 0.5rem;
     padding-bottom: 0.5rem;
     z-index: 10;
     border-bottom: 1px solid #e5e7eb; /* Tailwind gray-200 */
     margin-bottom: 0.5rem;
    }
    #upcomingAppointments > div,
    #appointmentHistory > div {
     overflow-y: auto;
     flex-grow: 1;
     padding-right: 0.25rem; /* for scrollbar space */
    }
    #upcomingAppointments > div button,
    #appointmentHistory > div button {
     min-height: 3.5rem; /* enough to show at least 2 lines comfortably */
     display: flex;
     align-items: center;
     padding-top: 0.5rem;
     padding-bottom: 0.5rem;
    }
   }
   /* Move Settings button slightly right near edge */
   #settingsButton {
    margin-left: 2rem !important;
   }
  </style>
 </head>
 <body class="bg-gray-100 font-sans flex flex-col min-h-screen relative overflow-x-hidden">
  <header class="bg-blue-600 shadow-md">
   <nav class="w-full flex items-center justify-between h-16">
    <div class="flex items-center space-x-2">
     <img
      alt="Doctor icon with a person in a lab coat holding a clipboard"
      class="h-8 w-8 rounded ml-4"
      height="32"
      src="Pictures/Logo.jpg"
      width="32"
     />
     <span class="text-white font-semibold text-base select-none">DocNow</span>
    </div>
    
    <!-- Desktop Navigation -->
    <div class="hidden md:flex items-center space-x-6 px-4">
     <a
      href="index.php"
      class="bg-blue-900 text-white px-3 py-1.5 rounded-md text-sm font-semibold select-none"
      >Home</a
     >
     <a
      href="doctors.php"
      class="text-white text-sm select-none hover:text-blue-300 transition-colors font-semibold"
      >Doctors</a
     >
     <a
      href="appointments.php"
      class="text-white text-sm select-none hover:text-blue-300 transition-colors font-semibold"
      >Booking</a
     >
     <div class="relative">
      <input
       class="bg-blue-700 placeholder-blue-300 text-white text-sm rounded-md pl-3 pr-8 py-1.5 focus:outline-none"
       placeholder="Search..."
       type="text"
      />
      <span class="absolute right-2 top-1.5 text-white text-sm">
       <i class="fas fa-search"></i>
      </span>
     </div>
     <div class="relative">
      <button
       id="settingsButton"
       aria-label="Open settings menu"
       class="text-white text-sm font-semibold px-3 py-1.5 rounded-md select-none hover:text-blue-300 transition-colors mr-4"
       onclick="toggleMenu()"
       type="button"
      >
       Settings
      </button>
     </div>
    </div>

    <!-- Mobile Navigation -->
    <div class="flex md:hidden items-center space-x-4 mr-4">
     <div class="relative">
      <input
       class="bg-blue-700 placeholder-blue-300 text-white text-sm rounded-md pl-3 pr-8 py-1.5 focus:outline-none w-32"
       placeholder="Search..."
       type="text"
      />
      <span class="absolute right-2 top-1.5 text-white text-sm">
       <i class="fas fa-search"></i>
      </span>
     </div>
     <button
      id="mobileMenuButton"
      aria-label="Open mobile menu"
      class="text-white text-xl p-2 hover:text-blue-300 transition-colors"
      onclick="toggleMobileMenu()"
      type="button"
     >
      <i class="fas fa-bars"></i>
     </button>
    </div>
   </nav>

   <!-- Mobile Menu -->
   <div id="mobileMenu" class="fixed inset-y-0 right-0 w-64 bg-blue-800 transform translate-x-full transition-transform duration-200 ease-in-out md:hidden">
    <div class="flex flex-col h-full">
     <div class="flex justify-end p-4">
      <button
       aria-label="Close mobile menu"
       class="text-white text-xl p-2 hover:text-blue-300 transition-colors"
       onclick="toggleMobileMenu()"
       type="button"
      >
       <i class="fas fa-times"></i>
      </button>
     </div>
     <nav class="flex flex-col space-y-4 p-4">
      <a href="index.php" class="text-white text-sm font-semibold hover:text-blue-300 transition-colors">Home</a>
      <a href="doctors.php" class="text-white text-sm font-semibold hover:text-blue-300 transition-colors">Doctors</a>
      <a href="appointments.php" class="text-white text-sm font-semibold hover:text-blue-300 transition-colors">Booking</a>
      <hr class="border-blue-700">
      <a href="profile.php" class="text-white text-sm font-semibold hover:text-blue-300 transition-colors">Account</a>
      <a href="logout.php" class="text-white text-sm font-semibold hover:text-blue-300 transition-colors">Sign Out</a>
     </nav>
    </div>
   </div>
  </header>

  <!-- Slide menu -->
  <div
   aria-label="Slide menu"
   class="fixed top-16 right-4 h-auto w-52 bg-white rounded-lg shadow-lg border border-gray-200 hidden z-50"
   id="slideMenu"
  >
   <nav class="mt-8 flex flex-col space-y-3 px-6 pb-6">
    <a
     class="text-gray-800 font-semibold hover:text-blue-600 select-none rounded-md px-3 py-2 transition-colors"
     href="profile.php"
     >Account</a
    >
    <a
     class="text-gray-800 font-semibold hover:text-blue-600 select-none rounded-md px-3 py-2 transition-colors"
     href="logout.php"
     >Logout</a
    >
   </nav>
  </div>

<main class="w-full px-4 sm:px-6 lg:px-8 mt-8 mb-8 flex-grow">
   <h2 class="text-gray-900 font-semibold text-lg mb-6 select-none">Patient Profile</h2>
   <div class="flex flex-col lg:flex-row lg:space-x-6">
    <!-- Left Column - Patient Profile -->
    <div class="lg:w-[30%]">
     <section
      aria-label="Patient Profile Information"
      class="bg-white rounded-lg shadow-md h-[calc(100vh-180px)]"
      id="profileContainer"
     >
      <div class="p-6 h-full overflow-y-auto">
       <div class="flex flex-col space-y-1 mb-6">
        <div class="flex items-center space-x-4">
         <div class="relative">
          <img
           id="profilePic"
           alt="Profile picture"
           class="rounded-full border border-gray-300 w-20 h-20 object-cover cursor-pointer"
           src="Pictures/Logo.jpg"
           onclick="document.getElementById('profilePicInput').click()"
          />
          <div id="profilePicLoading" class="absolute inset-0 bg-gray-200 rounded-full flex items-center justify-center hidden">
           <span class="text-gray-500 text-sm">Uploading...</span>
          </div>
          <input
           type="file"
           accept="image/*"
           id="profilePicInput"
           class="hidden"
           onchange="handleProfilePicChange(event)"
          />
          <div class="absolute bottom-0 right-0 bg-blue-600 rounded-full p-1 cursor-pointer"
               onclick="document.getElementById('profilePicInput').click()">
           <i class="fas fa-camera text-white text-xs"></i>
          </div>
         </div>
         <div class="flex flex-col">
          <h4 id="nameDisplay" class="text-lg font-semibold text-gray-900">
            <?php echo htmlspecialchars($user_name); ?>
          </h4>
          <span id="emailDisplay" class="text-sm text-gray-600">
            <?php echo htmlspecialchars($user_email); ?>
          </span>
          <span id="roleDisplay" class="text-xs text-gray-500 mt-1">
            <?php echo htmlspecialchars(ucfirst($user_role)); ?>
          </span>
          <span id="userIdDisplay" class="text-xs text-gray-500">
            ID: <?php echo htmlspecialchars($user_id); ?>
          </span>
         </div>
        </div>
       </div>
       <div class="grid grid-cols-1 sm:grid-cols-3 gap-x-6 gap-y-2 mb-4 text-sm text-gray-900">
        <div>
         <span class="font-semibold select-none">Age:</span>
         <span class="editable-field select-text" data-name="age" id="age" data-type="number">Not specified</span>
        </div>
        <div>
         <span class="font-semibold select-none">Gender:</span>
         <span class="editable-field select-text" data-name="gender" id="gender" data-type="text">Not specified</span>
        </div>
        <div>
         <span class="font-semibold select-none">Marital Status:</span>
         <span class="editable-field select-text" data-name="maritalStatus" id="maritalStatus" data-type="text">Not specified</span>
        </div>
       </div>
       <p class="mb-4 text-sm text-gray-900">
        <span class="font-semibold select-none">Bio:</span>
        <span class="editable-field select-text" data-name="bio" id="bio" data-type="textarea">No bio provided</span>
       </p>
       <p class="mb-2 text-sm text-gray-900">
        <span class="font-semibold select-none">Address:</span>
        <span class="editable-field select-text" data-name="address" id="address" data-type="text">No address provided</span>
       </p>
       <p class="mb-2 text-sm text-gray-900">
        <span class="font-semibold select-none">Emergency Contact Name:</span>
        <span class="editable-field select-text" data-name="emergencyContactName" id="emergencyContactName" data-type="text">Not provided</span>
       </p>
       <p class="mb-2 text-sm text-gray-900">
        <span class="font-semibold select-none">Emergency Contact Phone:</span>
        <span class="editable-field select-text" data-name="emergencyContactPhone" id="emergencyContactPhone" data-type="text">Not provided</span>
       </p>
       <p class="mb-6 text-sm text-gray-900">
        <span class="font-semibold select-none">Emergency Contact Relationship:</span>
        <span class="editable-field select-text" data-name="emergencyContactRelationship" id="emergencyContactRelationship" data-type="text">Not specified</span>
       </p>
       <button
        class="bg-blue-600 hover:bg-blue-700 text-white font-semibold text-sm px-4 py-2 rounded select-none"
        data-editing="false"
        id="editProfileBtn"
        onclick="toggleEdit()"
        type="button"
       >
        Edit Profile
       </button>
      </div>
     </section>
    </div>

    <!-- Middle Column - Appointments -->
    <div class="lg:w-[40%]">
     <div class="bg-white rounded-lg shadow-md h-[calc(100vh-180px)] flex flex-col">
      <!-- Upcoming Appointments -->
      <section
       id="upcomingAppointments"
       aria-label="Upcoming Appointments"
       class="p-6 flex-1 flex flex-col"
      >
       <h3 class="text-gray-900 font-semibold text-base mb-4 border-b border-gray-200 py-2 sticky top-0 bg-white z-10">
        Upcoming Appointments
       </h3>
       <div class="overflow-y-auto flex-1 space-y-3 pr-2">
        <p class="text-gray-500 text-center py-4" id="upcomingAppointmentsLoading">Loading appointments...</p>
       </div>
      </section>

      <hr class="border-gray-200 mx-6 my-0">

      <!-- Appointment History -->
      <section
       id="appointmentHistory"
       aria-label="Appointment History"
       class="p-6 flex-1 flex flex-col"
      >
       <h3 class="text-gray-900 font-semibold text-base mb-4 border-b border-gray-200 py-2 sticky top-0 bg-white z-10">
        Appointment History
       </h3>
       <div class="overflow-y-auto flex-1 space-y-3 pr-2">
        <p class="text-gray-500 text-center py-4" id="appointmentHistoryLoading">Loading appointment history...</p>
       </div>
      </section>
     </div>
    </div>

    <!-- Right Column - Messages & Notifications -->
    <div class="lg:w-[30%]">
     <section
      id="messagesNotifications"
      class="bg-white rounded-lg shadow-md h-[calc(100vh-180px)]"
     >
      <div class="p-6 h-full flex flex-col">
       <h3 class="text-gray-900 font-semibold text-base mb-4 border-b border-gray-200 py-2 sticky top-0 bg-white">
        Messages & Notifications
       </h3>
       <div id="messagesNotificationsList" class="space-y-3 overflow-y-auto flex-1 pr-2">
        <p class="text-gray-500 text-center py-4" id="notificationsLoading">Loading notifications...</p>
       </div>
      </div>
     </section>
    </div>
   </div>
  </main>

  <!-- Modal for notification and message content -->
  <div
   class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-60 hidden"
   id="modal"
  >
   <div class="bg-white rounded-lg shadow-lg max-w-md w-full p-6 relative">
    <button
     aria-label="Close modal"
     class="absolute top-2 right-2 text-gray-600 hover:text-gray-900 text-xl focus:outline-none"
     onclick="closeModal()"
    >
     <i class="fas fa-times"></i>
    </button>
    <div class="text-gray-900 text-sm mb-4" id="modalContent"></div>
    <div class="hidden" id="modalReply">
     <textarea
      class="w-full border border-gray-300 rounded px-2 py-1 text-sm resize-none"
      id="modalReplyTextarea"
      rows="4"
      placeholder="Type your reply..."
     ></textarea>
     <button
      class="mt-3 bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold px-4 py-2 rounded"
      id="modalReplySend"
      type="button"
     >
      Send
     </button>
    </div> 
   </div>
  </div>

  <!-- Appointment Details Modal -->
  <div id="appointmentModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
   <div class="bg-white rounded-lg shadow-lg max-w-md w-full mx-4">
    <div class="flex justify-between items-center p-4 border-b border-gray-200">
     <h3 class="text-lg font-semibold text-gray-900">Appointment Details</h3>
     <button onclick="closeAppointmentModal()" class="text-gray-400 hover:text-gray-600">
      <i class="fas fa-times"></i>
     </button>
    </div>
    <div class="p-4">
     <div id="appointmentDetails"></div>
    </div>
   </div>
  </div>

  <!-- Message Popup -->
  <div id="messageModal" class="fixed inset-0 hidden items-center justify-center z-50">
   <div class="fixed inset-0 bg-black bg-opacity-50" onclick="closeMessageModal()"></div>
   <div class="bg-white rounded-lg shadow-lg w-[500px] relative z-10">
    <div class="flex justify-end p-2">
     <button onclick="closeMessageModal()" class="text-gray-400 hover:text-gray-600">
      <i class="fas fa-times"></i>
     </button>
    </div>
    <div class="px-6 pb-6">
     <div id="messageContent" class="mb-6 border-b border-gray-200 pb-4"></div>
     <div class="bg-white rounded-lg">
      <textarea
       id="messageReply"
       class="w-full border border-gray-200 rounded-lg p-4 focus:outline-none focus:border-blue-500 resize-none"
       rows="4"
       placeholder="Type your reply..."
      ></textarea>
      <div class="flex justify-end mt-4">
       <button
        onclick="sendReply()"
        class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors text-sm font-semibold"
       >
        Send
       </button>
      </div>
     </div>
    </div>
   </div>
  </div>

  <footer class="bg-gray-800 text-white py-2 rounded-t-lg shadow-md text-center mt-8">
   <p class="text-sm">Â© 2023 DocNow. All rights reserved.</p>
  </footer>
 </body>
</html>